<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover">
    <title>Kemenangan Signature</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="manifest" href="_manifest.json?a=1" data-pwa-version="set_in_manifest_and_pwa_js">
    <link rel="apple-touch-icon" sizes="180x180" href="https://amazingteam.biz/atc.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@2.1.0/build/pure-min.css" integrity="sha384-yHIFVG6ClnONEA5yB5DJXfW2/KC173DIQrYoZMEtBvGzmf0PKiGyNEqe9N6BNDBH" crossorigin="anonymous">
    <style>
        @media screen and (min-width: 800px) {
            body {
                padding-left: 20%;
                padding-right: 20%;
            }
            #footer-bar, .page-title {
                margin-left: 20%;
                width: 60%;
            }
        }
        .button-success, .button-error, .button-warning, .button-secondary {
            color: white;
            border-radius: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }
        .button-success { background: rgb(28, 184, 65); }
        .button-error { background: rgb(202, 60, 60); }
        .button-warning { background: rgb(223, 117, 20); }
        .button-secondary { background: rgb(66, 184, 221); }
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }
        .panel {
            padding-bottom: 10px;
        }
        #cam, #photo {
            width: 100%;
            border: 1px solid black;
        }
        #photo {
            border-style: dashed;
        }
    </style>
</head>

<body class="theme-light">
    <div style="display:none" id="reflink">https://amazingteam.biz/reg.php?id=/</div>
    <div id="preloader"><div class="spinner-border color-highlight" role="status"></div></div>

    <div id="page">
        <div class="header header-fixed header-logo-center header-auto-show">
            <a href="#" data-back-button class="header-icon header-icon-1"><i class="fas fa-chevron-left"></i></a>
        </div>  

        <div class="page-title page-title-fixed"></div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        
        <div class="page-content">
            <p class="location-support"></p>
            <p class="location-coordinates"></p>
            <div style="width:100%">
                <video style="width:100%;overflow:hidden" id="videoElement" autoplay muted playsinline>Not available</video>
                <canvas id="canvasElement" style="display:none"></canvas>
                <img id="photoElement" style="width:100%;display:none">
            </div>
            <div class="panel">
                <div style="width:100%;float:left">
                    <button id="snapButton" class="button-success pure-button" style="float:left;margin-top:10px;margin-left:50px;">Ambil Foto</button>
                    <button id="retryButton" class="button-error pure-button" style="float:right;margin-top:10px;margin-right:50px;margin-left:auto;">Retry</button>
                </div>

                <div style="width:100%;float:left">
                    <button id="confirmButton" class="button-secondary pure-button" style="width:100%;margin-top:20px;">Confirm Upload</button>
                </div>
            </div>
        </div>
        <!-- Page content ends here-->
    </div>
    
    <script>
        // Ensure that the device has a camera before using this function
        async function initializeCamera() {
            await switchCamera("environment");
        }

        // Variable to store the current media stream
        let mediaStream = null;

        // Camera constraints
        const cameraConstraints = {
            audio: false,  // Disable audio for taking photos
            video: {
                width: { ideal: 1050 },
                height: { ideal: 700 },
                facingMode: "environment",
            },
        };

        async function getMediaStream(constraints) {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = mediaStream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                };
            } catch (err) {
                console.error(err.message);
                alert("Error accessing camera: " + err.message);
            }
        }

        async function switchCamera(cameraMode) {
            try {
                // Stop the current video stream
                if (mediaStream && mediaStream.active) {
                    const tracks = mediaStream.getVideoTracks();
                    tracks.forEach(track => track.stop());
                }
                
                // Reset video source
                document.getElementById('videoElement').srcObject = null;
                
                // Change "facingMode"
                cameraConstraints.video.facingMode = cameraMode;
                
                // Get new media stream
                await getMediaStream(cameraConstraints);
            } catch (err) {
                console.error(err.message); 
                alert("Error switching camera: " + err.message);
            }
        }
        
        function clearPhoto() {
            const canvasElement = document.getElementById('canvasElement');
            const photoElement = document.getElementById('photoElement');
            const canvasContext = canvasElement.getContext('2d');  // Corrected context
            canvasContext.fillStyle = "#AAA";
            canvasContext.fillRect(0, 0, canvasElement.width, canvasElement.height);
            const dataUrl = canvasElement.toDataURL('image/png');
            photoElement.setAttribute('src', dataUrl);
        }

        function takePicture() {
            $("#videoElement").hide();
            $("#photoElement").show();
            const canvasElement = document.getElementById('canvasElement');
            const videoElement = document.getElementById('videoElement');
            const photoElement = document.getElementById('photoElement');
            const canvasContext = canvasElement.getContext('2d');  // Corrected context
            
            const videoHeight = videoElement.videoHeight;
            const videoWidth = videoElement.videoWidth;
            
            if (videoWidth && videoHeight) {
                canvasElement.width = videoWidth;
                canvasElement.height = videoHeight;
                canvasContext.drawImage(videoElement, 0, 0, videoWidth, videoHeight);
                const dataUrl = canvasElement.toDataURL('image/png');
                
                photoElement.setAttribute('src', dataUrl);
            } else {
                clearPhoto();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const snapButton = document.getElementById('snapButton');
            const retryButton = document.getElementById('retryButton');
            const confirmButton = document.getElementById('confirmButton');
            const photoElement = document.getElementById('photoElement');
            const videoElement = document.getElementById('videoElement');
            const loadingElement = $(".loading");

            snapButton.addEventListener('click', (event) => {
                takePicture();
                event.preventDefault();
            });

            retryButton.addEventListener('click', (event) => {
                clearPhoto();
                $(videoElement).show();
                $(photoElement).hide();
            });

            confirmButton.addEventListener('click', async (event) => {
                loadingElement.show();
                const base64Image = photoElement.getAttribute('src');

                try {
                    const formData = new FormData();
                    formData.append('data', base64Image);

                    const response = await fetch('https://absen.kemenangansignature.com/upimg.php', {
                        method: 'POST',
                        body: formData,
                        mode: 'cors'
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const jsonData = await response.json();
                    alert('Upload Success');

                    // Send jsonData to Kolase API
                    await sendToCreateKolaseImage(jsonData);
                } catch (err) {
                    console.error('Upload failed:', err.message);
                    alert('Upload failed: ' + err.message);
                } finally {
                    loadingElement.hide();
                }
            });

            // Function to send data to Kolase API 
            async function sendToCreateKolaseImage(data) {
                try {
                    const requestData = {
                        image1_url: data.img, 
                        image2_url: data.img, // Assuming the second value from jsonData
                    };
                    const response = await fetch('http://152.42.252.10:5000/create_kolase', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to send data to other API');
                    }

                    const responseData = await response.json();
                    console.log('Response from other API:', responseData);
                    // Handle response from other API as needed
                } catch (err) {
                    console.error('Error sending data to other API:', err.message);
                    // Handle error
                }
            }

            // Initialize the camera
            initializeCamera();
        });
    </script>

</body>
</html>
